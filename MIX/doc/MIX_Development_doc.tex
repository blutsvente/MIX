%
%   MIX  - Developer Documentation
%

\documentclass[a4paper,12pt]{article}
\setlength{\textwidth}{170mm}
\setlength{\textheight}{255mm}
\setlength{\oddsidemargin}{-5mm}
\setlength{\topmargin}{-18mm}

\usepackage[T1]{fontenc}
\usepackage[latin1]{inputenc}
%\usepackage{supertabular}
\usepackage{epsfig}
\usepackage{xr}

\title{MIX - Micronas Interconnect Specification Expander}
\author{Development Documentation}
\date{6.10.2003}

%\family{cmss}
%\selection

\begin{document}

%\begin{titlepage}
%\begin{tabular}{p{20mm}l}
%\multicolumn{2}{r}{\bf {MIX} - Micronas Interconnect spec. eXpander}\\[1mm]
%\hline \\[3mm]
%& MIX - \\
%& Developer\\
%& Documentation\\[5mm]
%& Micronas - Munich\\[5mm]
%\hline \\[20mm]
%\end{tabular}
%\end{titlepage}gin{titlepage}

\maketitle
\newpage

\tableofcontents
\newpage


\section{Introduction}
This Document will give Developers a short introduction into Micronas Interconnect Specification Expander Libraries. It will \underline{not} give any help about MIX usage, if you need information about this, please refer the MIX-Userreference. The following Sections will give some functional overview and coding examples.


\section{Installation and Setup}
\subsection{Requirements}
Because of MIX is a Perl script (using additional Packages), you will have to install a Perl 5 interpreter. You may use the Packages included in CVS or optionally, download each of your own from the Internet. If you are using Linux you might find Perl 5 already beeing installed. The Packages included in cvs where used for developing and testing MIX, if you refer problems please you these ones. If you are using Windows you should install WinCVS (most Linux-Distributions include a CVS client per default) for keeping up to date and permiting own changes.


\subsection{Getting from CVS}
Instead using a obsolete Version you should decide to get MIX from CVS. The following steps discribe what to do, if you want to get MIX via this way:
\begin{enumerate}
\item{install a CVS client (visit http://www.wincvs.org for more information)}
\item{install a ssh client (visit http://lexa.mckenna.edu/sshwindows/)}
\item{change to the Base directory where you wan't MIX to recide}
\item{set a Environment variable called "CVSRSH" to "ssh"}
\item{enter the command: \tt{cvs -z3 -d:ext:...... co mix}}
\item{optionally: install ActiveState Perl and Komodo}
\item{optionally: download packages from CPan (http://cpan.perl.com)}
\end{enumerate}
Further informations about cvs usage could be found at: http://www.sourceforge.net\newline
\hspace*{10mm}- select "Site Docs" from the section "SF.net Resources"\newline
\hspace*{10mm}- visit section "F", which contains various information about CVS


\section{Basic Concepts}
\subsection{Input/Output formats}
As mentioned above you won't find here any information about "how to build Hierachical, Connectivity and IO-Sheets", because of the MIX-Userreference gives some examples how to do this. In this point please read the MIX-Userreference.


\subsection{Basical steps}
The MIX main program, called "\begin{tt}mix\_0.pl\end{tt}", is containing calls to functions located in the Micronas Package. These calls represent MIX's procedural flow. Each of this procedures solves some basical problems, the following steps represent sections which include similar functions.
\begin{enumerate}
\item{Initialize the \begin{tt}\%EH\end{tt} variable (most configuration is hold inside of it)}
\item{Processing of command line switches, at least one argument has to be specified}
\item{Read the input files one by one and retrieve tables (simple convert into Arrays of Hashes)}
\item{Retrieve generator statements (generator, macros) from input data}
\item{Initialize Hierarchy Data Base and convert to internal format}
\item{Parse connectivity and IO sheet and convert to internal format}
\item{Apply connectivity macros, hierachical and connectivity generation}
\item{Do some internal clean up}
\item{Replace all occurences of \begin{tt}\%MACRO\%\end{tt} in \begin{tt}\%hierdb\%\end{tt} and \begin{tt}\%conndb\%\end{tt}}
\item{Add connections and ports if needed (hierarchy traversal)}
\item{Clean up again}
\item{Add a list of all signals for each instance and generate entities}
\item{Dump intermediate data}
\item{Write output (entities, architecture, configuration and status) and exit}
\end{enumerate}


\subsection{Spreadsheet Operations}
The first example will show the usage of  \begin{tt}MixUtils::IO\end{tt} which is used for Spreadsheet read and write Operations.This code converts a Excel Spreadsheet to the Star-Office Spreadsheet format. See MixUtils Section for other supported file-formats).
\begin{verbatim}

#!/usr/bin/perl -w

use strict;
use Cwd;
use File::Basename;
use Getopt::Long qw(GetOptions);
use Pod::Text;

use vars qw($pgm $base $pgmpath $dir);

$dir = "";
($^O=~/Win32/) ? ($dir=getcwd())=~s,/,\\,g : ($dir=getcwd());

BEGIN{     # 
    ($^O=~/Win32/) ? ($dir=getcwd())=~s,/,\\,g : ($dir=getcwd());    

    ($pgm=$0) =~s;^.*(/|\\);;g;
    if ( $0 =~ m,[/\\],o ) { #$0 has path ...
        ($base=$0) =~s;^(.*)[/\\]\w+[/\\][\w\.]+$;$1;g;
        ($pgmpath=$0) =~ s;^(.*)[/\\][\w\.]+$;$1;g;
    } else {
        ( $base = $dir ) =~ s,^(.*)[/\\][\w\.]+$,$1,g;
        $pgmpath = $dir;
    }
}

# $pgmpath contains the programs path (this skripts path)

use lib "$pgmpath/MIX/lib/perl";     # search Libraries in Subdir MIX/lib/perl

use Log::Agent;
use Log::Agent::Priorities qw(:LEVELS);
use Log::Agent::Driver::File;

use Micronas::MixUtils;       # contains the EH Variable and other every-day stuff
use Micronas::MixUtils::IO;   # here you find input and 
                              # ouput Spreadsheet-File Handling

#******************************************************************************
# Global Variables
#******************************************************************************

if(scalar(@ARGV)!=1) {
    logwarn "usage: xls2sxc.pl <excel-file>";
    die;
}

mix_init();

my $file = $ARGV[0];

if(not $file=~ m/.xls/) {
    $file = $file . ".xls";
}

if($ARGV[0]=~ m/.xls$/) {
    $ARGV[0]=~ s/.xls$/.sxc/;
} 
elsif(not $ARGV[0]=~ m/.sxc$/) { 
    $ARGV[0] .= ".sxc";
}

my $oBook = Spreadsheet::ParseExcel::Workbook->Parse($file);   # Excel Parser Module

if(!$oBook || !defined $oBook) {
    logwarn("ERROR: File <$file> not found");
    die;
}

my $sheet;
my $sname = "";
my @data = ();

my $ref;


for(my $i=0; $i<$oBook->{SheetCount}; $i++) {  # for all sheets in the file

    $sheet = $oBook->{Worksheet}[$i];    # get Sheet, number $i from Object
    $sname = $sheet->{Name};             # get the Sheets name

    @data = open_xls($file, $sname, 0);  # open $file, read Sheet $sname; no flags
    $ref = pop(@data);       # get the first sheet of the name $sname which was found
    write_sxc($ARGV[0], $sname, $ref);# write to file,
                                      # createsheet with name containing data of $ref 
}

\end{verbatim}
The number of Sheets, with the same name to keep, as many other things is conatined in the EH Variable. This Variable is initialized by the call of mix\_init(), optional you may setup your completly own EH Variable, but you will have to look into MixUtils%backslash%IO.pm for the requirements. The \begin{tt}pop(@data)\end{tt} is needed because Mix's read Functions returns a list of every Sheet of the given name.


\subsection{Mix parsing Extensions}
Writing a Mix parsing Extension is even easy as Spreadsheet operations. Mix does it's work by mapping input Information (taken from a Spreadsheet) on instances and connections. These are keept inside of two Perl-Hash Databases \begin{tt}%hierdb\end{tt} and \begin{tt}%conndb\end{tt}. Elements can be added by using \begin{tt}add_inst(%instance_def)\end{tt} and \begin{tt}add_conn(%connection_def)\end{tt}.\newline
  Adding a Instance \begin{tt}FooBar\end{tt} to \begin{tt}TOPLEVEL\end{tt} is done by:\newline
\begin{verbatim}
    my %my_instance = ( '::inst' => "FooBar",
                        '::entity' => "foobar",
                        '::parent' => "TOPLEVEL", );

    add_inst(%my_instance);
\end{verbatim}
For other settings see \begin{tt}MIX\_Userreference\end{tt}. The definition of those (called the Headers) is done in the Mix-Module \begin{tt}MixUtils.pm\end{tt} (located in the \begin{tt}mix\_init()\end{tt} Function, inside the \begin{tt}EH\end{tt} structure). The following Listing shows the I$^2$C Header definiton:\newline
\begin{verbatim}
    'i2c' => {
        'xls' => 'I2C',
	'req' => 'optional',
	'parsed' => 0,
	'field' => {
	    #Name   	=>	  	    Inherits
	    #					    Multiple
	    #						    Required
	    #							  Defaultvalue
	    #								    PrintOrder
	    #                                   0       1       2	3       4
	    '::ign' 		=> [ qw(	0	0	1	%EMPTY%     1)],
	    '::variants'	=> [ qw(	1	0	0	Default	     2)],
	    '::dev'             => [ qw(        0       0       1       %EMPTY%     3)],
	    '::sub'             => [ qw(        0       0       1       %EMPTY%     4)],
	    '::interface'       => [ qw(        0       0       1       %EMPTY%     5)],
	    '::dir'             => [ qw(        0       0       1       RW           6)],
	    '::spec'            => [ qw(        0       0       0       NTO          7)],
	    '::clock'           => [ qw(        0       0       1       %OPEN%      8)],
	    '::reset'           => [ qw(        0       0       1       %OPEN%      9)],
	    '::busy'            => [ qw(        0       0       0       %EMPTY%     10)],,
	    '::b'		=> [ qw(	0	1	1	%OPEN%      11)],
	    '::init'            => [ qw(        0       0       0       0            12)],
	    '::rec'             => [ qw(        0       0       0       0            13)],
	    '::comment'	        => [ qw(	1	1	2	%EMPTY%     14)],
	    '::default'	        => [ qw(	1	1	0	%EMPTY%     0)],
	    'nr'		=> 15,  # Number of next field to print
	},
    },
\end{verbatim}
Description: \begin{tt}xls\end{tt} Spreadsheet name (the name \begin{tt}xls\end{tt} is a relict from Excel-only-input-times)\newline
  \begin{tt}req\end{tt} tells Mix if this Sheet is mandatory\newline
\newline
The Tabular describes the characteristics of a Headers-field:\newline
In the first column you can find the names of the Headers, as you can see these are the Keywords you maybe known from your Spreadsheets\newline
\begin{tt}Inherits\end{tt} not needed, can be \begin{tt}0\end{tt}\newline
\begin{tt}Multiple\end{tt} if set to \begin{tt}1\end{tt} the Column may be located more then once, internal Mix numerates them begining from \begin{tt}0\end{tt}, naming convention is: \begin{tt}::$<$Headersname$>$:<number>\end{tt}; if <number> is \begin{tt}0\end{tt}: \begin{tt}::$<$Headername$>$\end{tt}\newline
\begin{tt}Required\end{tt} tells Mix if this Header must be located, if not Mix will return an error\newline
\begin{tt}Defaultvalue\end{tt} specifies a default entry if the column is empty and mandatory\newline
\begin{tt}PrintOrder\end{tt} internal numeration of Headers\newline
\begin{tt}nr\end{tt} simply lists the number of Headers defined\newline
\newline
To tell Mix to read in some more tabular, open \begin{tt}MixUtils/IO.pm\end{tt} and search for the \begin{tt}mix\_utils\_open_input(@)\end{tt} Function. Here you can find one Array and some calls for every Tabular. In the following example only I$^2$C operation is listed (normaly this function return 4 array-references, i.e.):
\begin{verbatim}
sub mix_utils_open_input(@) {
    my @in = @_;

    my $ai2c = [];

    for my $i ( @in) {
     
        my $i2c;

	@i2c = open_infile($i, $EH{'i2c'}{'xls'}, $EH{'conf'}{'req'});

	for my $c ( $i2c) {
	    $EH{'i2c'}{'parsed'}++;
	    my $norm_i2c = convert_in("i2c", $c);
	    select_variant( \backslash@norm_i2c);
	    push(@$ai2c, @norm_i2c);
	}
    }
    return( $ai2c);
}
\end{verbatim}
For every Spreadsheet-File \begin{tt}\$i\end{tt}, a Table named like the value of \begin{tt}\$EH{'i2c'}{'xls'}\end{tt} is extracted. The last Argument of \begin{tt}mix_open_infile\end{tt}, the value of\begin{tt}\$EH{'conf'}{'req'}\end{tt}, specifies if this Table is need or not. The Function \begin{tt}open_infile\end{tt} return a Array of I$^2$C-Tables found (\$i2c[0] is the first Table found in the File \begin{tt}\$i\end{tt}). Next every I$^2$C-Tables Header-Row is matched, emtpy Cells are stiped of and the relevant Variant is selected. Header-Matching is done by \begin{tt}convert_in\end{tt}, while \begin{tt}select_variant\end{tt} selects the Variant. All Arrays \begin{tt}\@norm_i2c\end{tt} are pushed onto \begin{tt}\@\$ai2c\end{tt}. The Array returned consists a Two-Dimensional Array. If there was more than one all of them are pushed together.\newline
Next you would have to write a Parser. The Parser will take Input-Information and create hierrarchical Units and Connections of it. The following example shows some part MIX's I$^2$C-Parser (for some more practical examples see \begin{tt}MixIOParser.pm\end{tt}, \begin{tt}MixI2CParser.pm\end{tt} or \begin{tt}MixParser.pm\end{tt}):
\begin{verbatim}
sub parse_i2c_init($) {

    my $r_i2c = shift;

    my $ehr = $EH{'i2c'}{'field'};

    foreach my $i (@$r_i2c) {

        next if ( $i->{'::ign'} =~ m,^\s*(#|\\),); # Skip comments, just in case they sneak in

        for my $j ( keys %$ehr) {
	    next unless ( $j =~ m/^::/ );
	    if ( not defined( $i->{$j} )) {
		next if( $ehr->{$j}[2] eq 0);
		$i->{$j} = $ehr->{$j}[3];
	    }
	    elsif( $ehr->{$i}[2] && $i->{$j} eq "") {
		$i->{$j} = $ehr->{$i}[3]; # Set to DEFAULT Value
	    }
	}
	add_interface($i);
    }
    return 0;
}
\end{verbatim}
Ass you can see the parser checks if the cells of the passed Tables are defined, if not it sets a default Value. All fields marked as ignore are dropped.\newline
MIX uses two internal Databases, \begin{tt}\$hierdb\end{tt} and \begin{tt}\$conndb\end{tt}, for Maintaining and Processing HDL-Structures. Adding hierarchical Elements as well as Connections is done by the Functions \begin{tt}add_hier\end{tt} and \begin{tt}add_conn\end{tt}. The single Argument passed is a Hash-reference containing new Elements definition. The call to \begin{tt}add_interface\end{tt} adds a new I$^2$C-Registerblock, defined in \begin{tt}\$i\end{tt}, to \begin{tt}\$hierdb\end{tt} and \begin{tt}\$conndb\end{tt}. The Code below is only for demonstrating further work, it's not the Real "\begin{tt}MIXI2CPareser.pm\end{tt}" Code:\newline
\begin{verbatim}
sub add_interface(%) {

    my $in = shift;

    my %inst;
    my %conn

    # define a new instance
    my $name = $in->{'::interface'};
    $inst->{'::inst'} = $name;
    $inst->{'::entity'} = "PREFIX_". $name;

    # add it to hierdb
    $parent = add_inst( %$inst);

    # define a  new connection
    %conn = ( '::name' => "some_reset",
              '::in' => $name . "/reset",
              '::out' => $in->{'::reset'}, );

    # add it to conndb
    add_conn(%conn);
}
\end{verbatim}
This Code simply adds a new Instance named like the content of a "\begin{tt}::interface\end{tt}" cell. Next the connection of a Signal "\begin{tt}some_reset\end{tt}" is made from the out-pin specified in the cell called "\begin{tt}::reset\end{tt}" to the in-pin of the new create instance.



\section{The Package: Micronas}
Here can be found some additional information about the MIX Libraries which are inseperately part of MIX. The MIX-Libraries offer all MIX capabitlites for Parsing, Checking, Processing, reading and writing Data (HDL, Spreadsheets and internal Structures).


\subsection{Library: MixUtils}
This package includes some utilities which are used in most of the other packages. Because of there are a lot of functions here, only the most importend are mentioned. MixUtils is divided into the two Packages MixUtils and MixUtils::IO. The IO Package only contains Functions for Input-and Output Spreadsheet Operations. Supportet formats are Excel, Star-Office and CSV. Because of the Excel-Sheetwriter Function uses OLE it's only available for Windows. All other Spreadsheet Operations can be done without any external Program or Library.


\subsubsection{mix\_getopt\_header, mix\_getops, mix\_banner, mix\_usage and mix\_help}
These functions help us solving user interactions.\newline
\hspace*{10mm}- mix\_getopt\_header() and mix\_getops() are used to get command line options, paased by the user.
\hspace*{10mm}- mix\_banner() prints the headings MIX outputs to std every run
\hspace*{10mm}- mix\_usage() and mix\_help() are needed to print the program help and/or usage


\subsubsection{mix\_init and init\_ole}
The function mix\_init() initializes the \%EH variable with all the configuration we have/need. This variable keeps all configuation information while the program is running.\newline
The function init\_ole() initializes the Microsoft OLE System, which is needed for editing with Excel sheets.
\subsubsection{}


\subsection{Library: MixParser.pm}
The package provides the parsing capabilites for the MIX project. A matrix of information in some well-known format is converted into intermediate format and/or source code files.


\subsection{Library: MixIOParser.pm}
This Package provides the parsing capabilites for the MIX project. Take a matrix of information in some well-known format and convert it into intermediate format and/or source code files MixIOParser is spezialized in parsing the IO description sheet Information about IOcells and Pads will be converted to connection and hierachy and added to the HIER and CONN databases accordingly.


\subsection{Library: MixWriter.pm}
The package provides the output capabilites for the MIX project. Here you can find the following functions: \begin{it}generate\_entities\end{it}, \begin{it}write\_entities\end{it}, \begin{it}write\_architecture\end{it} and \begin{it}write\_configuration\end{it}.\newline


\subsubsection{generate\_entities ()}
Scan all of hierachy and create consistent, checked list of entities. An entity has a name and a portmap (generic map). Produced data structure will look like \$entities{\$name}{\$port}{type|from|to|mode}. Type will be generic or std\_logic or std\_ulogic ....\newline
This functions relies on \$hierdb{inst}{::conn}{::in|::out} to exist!\newline
TODO: Usage of hierdb is not nice. Search for a better way.\newline
TODO: Generics and inout mode ....\newline


\subsubsection{write\_entities ()}
This function writes entities into output file(s).\newline
\hspace*{10mm}\begin{it}ENTY\end{it} -$>$ write each entity in a file of it's own\newline
\hspace*{10mm}\begin{it}COMB(INE)\end{it} -$>$ combine entity, architecture and configuration\newline
This is mostly important for architecture and configuration. In the both cases above the entity name is used as filename. In all other cases "\begin{it}efname\end{it}" is used as entity file name (write all entities into one file of that name). In combine mode, \begin{it}entity.vhd\end{it} is choosen as filename. Filename extension defaults to VHDL.


\subsubsection{write\_architecture ()}
This function writes architecture into (VHDL/Verilog) output file(s).


\subsubsection{write\_configuration ()}
This function writes configurarion into (VHDL/Verilog) output file(s).


\subsection{Library: MixChecker.pm}
Ths package here provides the checking capabilites for the MIX project. Accepts the intermediate (aka. final connection and hierachy description) and check if everything against your company design guide lines. Through plug-ins you can add these checks at will.


% \epsfig{file=name.eps,height=1.5in,width=5in}
\end{document}


